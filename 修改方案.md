# 数据库比较连接问题修改方案

## 🔍 问题分析

### 现状对比
1. **测试连接功能** ✅ 正常工作
   - 路径: `web-server/src/routes/database.ts` 的 `/test-connection` 端点
   - 使用: 直接的 `sql.ConnectionPool(config)` 
   - 结果: 连接成功

2. **数据库比较功能** ❌ SSL协议错误  
   - 路径: `src/app.ts` 的 `compareDatabase` 方法
   - 使用: 相同配置但仍然出现SSL错误
   - 错误: `SSL routines:ssl_choose_client_version:unsupported protocol`

### 根本原因
虽然我复制了相同的连接配置，但比较功能可能还在使用旧的 `DatabaseConnection` 类，或者配置中有细微差异。

## 💡 解决方案

### 方案一：直接复制test-connection的连接逻辑（推荐）

**修改文件**: `src/app.ts`

**具体操作**:
1. 完全删除当前的连接逻辑
2. 直接复制 `web-server/src/routes/database.ts` 中 `/test-connection` 端点的连接代码
3. 确保使用完全相同的创建、连接、查询模式

### 方案二：创建通用连接函数

**新建文件**: `src/utils/database-connection.ts`

**内容**: 
- 提取test-connection中成功的连接逻辑到独立函数
- 两个功能都调用这个统一函数
- 确保连接逻辑完全一致

## 🛠️ 详细修改步骤

### 步骤1: 备份当前 app.ts 的连接部分
保存当前的元数据提取逻辑，只替换连接部分

### 步骤2: 替换连接逻辑
将 `compareDatabase` 方法中的连接部分替换为：

```typescript
// 使用与test-connection完全相同的连接方式
const createConnection = async (server: string, database: string, authType: string, username?: string, password?: string) => {
  const config: any = {
    server: server,
    database: database,
    port: 1433,
    options: {
      encrypt: false,
      trustServerCertificate: true,
      enableArithAbort: true,
      useUTC: false
    },
    connectionTimeout: 10000,
    requestTimeout: 10000
  };

  if (authType === 'sql') {
    config.user = username;
    config.password = password;
  }

  const pool = new sql.ConnectionPool(config);
  await pool.connect();
  return pool;
};
```

### 步骤3: 应用到源和目标数据库连接
```typescript
// 连接源数据库
const sourcePool = await createConnection(
  sourceConfig.server,
  sourceConfig.database, 
  sourceConfig.authentication.type,
  sourceConfig.authentication.username,
  sourceConfig.authentication.password
);

// 连接目标数据库  
const targetPool = await createConnection(
  targetConfig.server,
  targetConfig.database,
  targetConfig.authentication.type, 
  targetConfig.authentication.username,
  targetConfig.authentication.password
);
```

## ✅ 预期结果

修改后应该看到以下日志输出：
```
[数据库比较-INFO] 正在连接源数据库...
[数据库比较-INFO] ✅ 源数据库连接成功: 127.0.0.1/demo
[数据库比较-INFO] 正在连接目标数据库...
[数据库比较-INFO] ✅ 目标数据库连接成功: 127.0.0.1/demo
[数据库比较-INFO] 开始提取源数据库元数据...
```

而不再看到SSL协议错误。

## 🎯 推荐方案

**推荐使用方案一**，因为：
1. 简单直接，风险最低
2. 确保100%使用相同的连接逻辑  
3. 快速验证修复效果
4. 后续可以重构为方案二

请确认这个修改方案，我将按此方案修改代码。