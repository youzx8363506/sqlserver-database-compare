# SQL Server 数据库比较工具 - 部署运行文档

## 项目概述

本项目是一个基于 Node.js + React 的 SQL Server 数据库比较工具，支持通过Web界面进行数据库结构比较，并生成多种格式的报告文件（HTML、Excel、JSON），满足用户对"输出链接"的需求。

## 系统架构

```
┌─────────────────┐    HTTP请求    ┌─────────────────┐
│   前端 React    │ ──────────────► │  后端 Express   │
│   (端口3000)    │                │   (端口3001)    │
│                 │ ◄────────────── │                 │
└─────────────────┘   WebSocket    └─────────────────┘
                                            │
                                            ▼
                                   ┌─────────────────┐
                                   │  SQL Server     │
                                   │   数据库实例    │
                                   └─────────────────┘
```

## 环境要求

### 必需环境
- **Node.js**: >= 18.12.1 (推荐 LTS 版本)
- **npm**: >= 8.19.2
- **SQL Server**: 任何版本 (2008+)
- **操作系统**: Windows (已测试), Linux, macOS

### 数据库权限要求
- 能够连接到 SQL Server 实例
- 具有读取系统表和视图的权限
- 支持 Windows 认证或 SQL Server 认证

## 安装步骤

### 1. 克隆或下载项目

```bash
# 如果有Git仓库
git clone <repository-url>
cd sqlserverdatabasecompare

# 或者直接使用已有的项目目录
cd D:\code\sqlserverdatabasecompare
```

### 2. 安装后端依赖

```bash
cd web-server
npm install
```

### 3. 安装前端依赖

```bash
cd ../web-ui
npm install
```

## 开发环境运行

### 启动后端服务

```bash
# 在项目根目录下
cd web-server
npm run dev
```

后端服务将启动在 `http://localhost:3001`

### 启动前端服务

```bash
# 新开一个终端窗口，在项目根目录下
cd web-ui
npm run dev
```

前端服务将启动在 `http://localhost:3000`

### 访问应用

打开浏览器访问: `http://localhost:3000`

## 生产环境部署

### 1. 构建前端

```bash
cd web-ui
npm run build
```

构建产物将生成在 `web-ui/dist` 目录

### 2. 构建后端

```bash
cd web-server
npm run build
```

构建产物将生成在 `web-server/dist` 目录

### 3. 生产环境启动

```bash
# 启动后端服务
cd web-server
npm start

# 前端静态文件可以通过 nginx 或其他 web 服务器提供
# 或者集成到后端服务中
```

### 4. 环境变量配置

可以通过环境变量配置：

```bash
# 后端端口 (默认 3001)
PORT=3001

# 运行环境
NODE_ENV=production
```

## Docker 部署 (可选)

### 创建 Dockerfile

**后端 Dockerfile** (`web-server/Dockerfile`):
```dockerfile
FROM node:18-alpine

WORKDIR /app

# 复制 package.json
COPY package*.json ./
COPY ../src ./src

# 安装依赖
RUN npm ci --only=production

# 构建
RUN npm run build

EXPOSE 3001

CMD ["npm", "start"]
```

**前端 Dockerfile** (`web-ui/Dockerfile`):
```dockerfile
FROM node:18-alpine as build

WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80
```

### Docker Compose

创建 `docker-compose.yml`:
```yaml
version: '3.8'
services:
  backend:
    build: ./web-server
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
    
  frontend:
    build: ./web-ui
    ports:
      - "3000:80"
    depends_on:
      - backend
```

运行：
```bash
docker-compose up -d
```

## 使用指南

### 1. 配置数据库连接

1. 访问 `http://localhost:3000`
2. 在左侧配置**源数据库**连接信息：
   - 服务器地址: 如 `localhost` 或 `192.168.1.100\SQLEXPRESS`
   - 数据库名称: 如 `MyDatabase`
   - 认证方式: Windows认证 或 SQL Server认证
   - 如果选择SQL认证，填写用户名和密码

3. 在右侧配置**目标数据库**连接信息
4. 点击"测试数据库连接"确保连接成功

### 2. 执行比较

1. 确保两个数据库连接测试都成功
2. 点击"开始数据库比较"按钮
3. 系统将显示实时比较进度
4. 可以查看详细的执行日志

### 3. 查看结果和生成报告

1. 比较完成后查看结果摘要
2. 浏览不同类型的差异详情（表、索引、视图、存储过程、函数）
3. 在"报告链接"标签页生成报告：
   - 选择报告格式（HTML、Excel、JSON）
   - 点击"生成报告"
   - 获得可分享的报告链接
   - 支持在线查看、复制链接、下载文件

## API 接口文档

### 健康检查
```
GET /api/health
```

### 数据库连接
```
POST /api/database/test-connection
Content-Type: application/json

{
  "server": "localhost",
  "database": "MyDatabase",
  "authentication": {
    "type": "windows" | "sql",
    "username": "user",
    "password": "pass"
  }
}
```

### 启动比较
```
POST /api/compare/start
Content-Type: application/json

{
  "sourceDatabase": { ... },
  "targetDatabase": { ... },
  "options": {}
}
```

### 生成报告
```
POST /api/reports/generate/{taskId}
Content-Type: application/json

{
  "format": "html" | "excel" | "json",
  "options": {}
}
```

### 获取报告列表
```
GET /api/reports/list
```

## WebSocket 事件

- `comparison-progress` - 比较进度更新
- `comparison-complete` - 比较完成
- `comparison-error` - 比较错误
- `log-message` - 日志消息

## 故障排除

### 常见问题

1. **端口占用**
   ```bash
   # Windows 查看端口占用
   netstat -ano | findstr :3000
   netstat -ano | findstr :3001
   
   # 杀掉占用进程
   taskkill /PID <进程ID> /F
   ```

2. **数据库连接失败**
   - 检查 SQL Server 服务是否运行
   - 确认网络连接和防火墙设置
   - 验证用户权限和认证信息
   - 确认数据库名称正确

3. **前端页面空白**
   - 打开浏览器开发者工具查看 Console 错误
   - 检查 Network 选项卡的请求状态
   - 清除浏览器缓存并硬刷新 (Ctrl+F5)

4. **WebSocket 连接失败**
   - 确认后端服务正常运行
   - 检查防火墙是否阻止 WebSocket 连接
   - 查看浏览器控制台的 WebSocket 错误

### 日志查看

**后端日志**: 直接在运行后端服务的终端查看

**前端日志**: 浏览器开发者工具 Console 选项卡

### 性能优化

1. **大型数据库比较**
   - 增加内存限制: `node --max-old-space-size=4096`
   - 分批处理大量对象

2. **网络优化**
   - 启用 gzip 压缩
   - 使用 CDN 提供静态资源

## 技术支持

### 开发调试

```bash
# 后端调试模式
cd web-server
npm run dev

# 前端调试模式
cd web-ui
npm run dev
```

### 构建验证

```bash
# 验证后端构建
cd web-server
npm run build
npm start

# 验证前端构建
cd web-ui
npm run build
npm run preview
```

## 项目结构

```
sqlserverdatabasecompare/
├── src/                     # 原始CLI版本代码
├── web-server/              # 后端API服务
│   ├── src/
│   │   ├── routes/          # API路由
│   │   ├── services/        # 业务服务
│   │   └── app.ts           # 服务器入口
│   ├── package.json
│   └── tsconfig.json
├── web-ui/                  # React前端界面
│   ├── src/
│   │   ├── components/      # React组件
│   │   ├── pages/           # 页面组件
│   │   ├── services/        # API服务
│   │   └── types/           # 类型定义
│   ├── package.json
│   ├── vite.config.ts
│   └── tsconfig.json
├── reports/                 # 生成的报告文件
├── 部署运行文档.md
└── 启动说明.md
```

---

**SQL Server 数据库比较工具 v1.0.0**

*支持多格式报告生成和链接分享功能*