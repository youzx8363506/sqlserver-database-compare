# SQL Server 数据库比较工具 - 项目方案

## 需求分析

### 功能需求

1. **数据库连接管理**
   - 支持连接到两个不同的SQL Server数据库
   - 支持Windows认证和SQL Server认证
   - 连接配置的保存和管理

2. **数据库对象比较**
   - **表结构比较**：字段名、数据类型、长度、是否允许NULL、默认值、主键、外键
   - **索引比较**：索引名称、类型、包含的列、唯一性约束
   - **视图比较**：视图定义、依赖关系
   - **存储过程比较**：存储过程定义、参数
   - **函数比较**：函数定义、参数、返回类型

3. **报告生成**
   - HTML格式报告
   - Excel格式报告
   - JSON格式数据导出
   - 差异汇总统计

4. **差异检测类型**
   - 新增对象
   - 删除对象
   - 修改对象
   - 结构差异详情

### 非功能需求

1. **性能要求**
   - 支持大型数据库比较（1000+表）
   - 异步处理，避免阻塞
   - 进度显示

2. **易用性**
   - 命令行界面
   - 配置文件支持
   - 详细的错误信息

3. **扩展性**
   - 插件化报告格式
   - 可扩展的比较规则

## 技术方案

### 技术栈选择

1. **核心框架**
   - Node.js (LTS版本)
   - TypeScript（提供类型安全）

2. **数据库连接**
   - `mssql` - 官方SQL Server驱动
   - `tedious` - 底层连接库

3. **命令行工具**
   - `commander.js` - 命令行参数解析
   - `inquirer.js` - 交互式命令行界面
   - `chalk` - 彩色输出
   - `ora` - 进度指示器

4. **报告生成**
   - `handlebars` - HTML模板引擎
   - `exceljs` - Excel文件生成
   - `json2csv` - CSV导出

5. **配置管理**
   - `dotenv` - 环境变量管理
   - `joi` - 配置验证

6. **日志和调试**
   - `winston` - 日志管理
   - `debug` - 调试工具

### 架构设计

```
src/
├── config/           # 配置管理
│   ├── database.ts   # 数据库配置
│   └── app.ts        # 应用配置
├── connections/      # 数据库连接
│   ├── connection.ts # 连接管理器
│   └── pool.ts       # 连接池
├── extractors/       # 数据提取器
│   ├── base.ts       # 基础提取器
│   ├── tables.ts     # 表结构提取
│   ├── indexes.ts    # 索引提取
│   ├── views.ts      # 视图提取
│   ├── procedures.ts # 存储过程提取
│   └── functions.ts  # 函数提取
├── comparers/        # 比较器
│   ├── base.ts       # 基础比较器
│   ├── table.ts      # 表比较
│   ├── index.ts      # 索引比较
│   ├── view.ts       # 视图比较
│   ├── procedure.ts  # 存储过程比较
│   └── function.ts   # 函数比较
├── reporters/        # 报告生成器
│   ├── base.ts       # 基础报告器
│   ├── html.ts       # HTML报告
│   ├── excel.ts      # Excel报告
│   └── json.ts       # JSON导出
├── types/            # TypeScript类型定义
│   ├── database.ts   # 数据库对象类型
│   ├── comparison.ts # 比较结果类型
│   └── config.ts     # 配置类型
├── utils/            # 工具函数
│   ├── logger.ts     # 日志工具
│   ├── validator.ts  # 验证工具
│   └── formatter.ts  # 格式化工具
├── cli/              # 命令行接口
│   ├── commands/     # 命令实现
│   │   ├── compare.ts    # 比较命令
│   │   ├── config.ts     # 配置命令
│   │   └── report.ts     # 报告命令
│   └── index.ts      # CLI入口
└── app.ts            # 应用主入口
```

## 具体实现方案

### 阶段一：基础框架搭建

1. **项目初始化**
   ```bash
   npm init -y
   npm install typescript @types/node ts-node nodemon
   npx tsc --init
   ```

2. **依赖安装**
   ```bash
   # 核心依赖
   npm install mssql commander inquirer chalk ora
   npm install handlebars exceljs winston dotenv joi
   
   # 开发依赖
   npm install --save-dev @types/mssql @types/inquirer 
   npm install --save-dev @types/handlebars jest @types/jest
   ```

3. **基础配置文件**
   - `tsconfig.json` - TypeScript配置
   - `package.json` - 项目配置和脚本
   - `.env.example` - 环境变量模板

### 阶段二：数据库连接和数据提取

1. **连接管理器实现**
   - 支持连接字符串和配置对象
   - 连接池管理
   - 错误处理和重连机制

2. **数据提取器实现**
   - 表结构提取SQL查询
   - 索引信息提取
   - 视图、存储过程、函数定义提取
   - 元数据缓存机制

### 阶段三：比较算法实现

1. **比较引擎设计**
   - 基于对象名称的匹配
   - 深度比较算法
   - 差异分类和标记

2. **比较规则定义**
   - 忽略特定差异的规则
   - 自定义比较逻辑
   - 敏感度配置

### 阶段四：报告生成系统

1. **报告模板设计**
   - HTML模板（使用Bootstrap样式）
   - Excel模板（多工作表）
   - JSON结构定义

2. **报告生成器实现**
   - 模板渲染引擎
   - 数据格式化
   - 文件输出管理

### 阶段五：命令行界面

1. **CLI命令设计**
   ```bash
   sqldb-compare --help
   sqldb-compare init                 # 初始化配置
   sqldb-compare compare              # 执行比较
   sqldb-compare report --format html # 生成报告
   ```

2. **交互式配置**
   - 数据库连接向导
   - 比较选项设置
   - 报告选项配置

## 开发计划

### 第一周：环境搭建和基础框架
- 项目初始化
- 基础架构搭建
- 数据库连接实现

### 第二周：数据提取功能
- 表结构提取
- 索引信息提取
- 视图定义提取

### 第三周：比较算法实现
- 基础比较引擎
- 表结构比较
- 索引比较

### 第四周：报告系统和CLI
- HTML报告生成
- 命令行界面
- 测试和优化

## 使用示例

```bash
# 初始化配置
sqldb-compare init

# 快速比较
sqldb-compare compare --source "server1.database1" --target "server2.database2"

# 详细比较并生成HTML报告
sqldb-compare compare --config ./config.json --output ./reports --format html

# 只比较表结构
sqldb-compare compare --tables-only --output ./table-report.json
```

## 配置文件示例

```json
{
  "source": {
    "server": "localhost",
    "database": "Database1",
    "authentication": {
      "type": "sql",
      "username": "sa",
      "password": "password"
    }
  },
  "target": {
    "server": "localhost",
    "database": "Database2",
    "authentication": {
      "type": "windows"
    }
  },
  "comparison": {
    "includeObjects": ["tables", "indexes", "views", "procedures", "functions"],
    "ignoreCase": true,
    "ignoreWhitespace": true
  },
  "output": {
    "directory": "./reports",
    "formats": ["html", "excel", "json"],
    "filename": "database-comparison-{timestamp}"
  }
}
```